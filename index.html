<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Brassica Smart Monitoring</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            background: #f0f4f7; 
            text-align: center; 
            margin: 0; 
            padding: 20px; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .header { 
            background: #27ae60; 
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            width: 100%;
            max-width: 800px;
        }

        .grid { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            flex-wrap: wrap; 
            width: 100%;
            margin-bottom: 30px;
        }

        .card { 
            background: white; 
            padding: 25px; 
            border-radius: 15px; 
            width: 250px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }

        /* ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .label { color: #7f8c8d; font-size: 1.1rem; }
        .value { font-size: 2.5rem; font-weight: bold; color: #2c3e50; margin: 10px 0; }
        .unit { font-size: 1rem; color: #95a5a6; }
        .status { margin-top: 10px; font-weight: bold; font-size: 1.1rem; }
        #date-time { margin-bottom: 15px; font-size: 1.2rem; font-weight: bold; color: #2c3e50; }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .grid { flex-direction: column; align-items: center; gap: 15px; }
            .card { width: 85%; max-width: 300px; }
            .chart-container { width: 95%; }
        }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

    <div class="header">
        <h1>LoRa Leafy Brassica Monitor</h1>
        <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏ú‡∏±‡∏Å‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</p>
    </div>

    <div id="date-time">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤...</div>

    <div class="grid">
        <div class="card">
            <div class="label">üå°Ô∏è ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</div>
            <div class="value" id="temp">--</div>
            <div class="unit">‡∏≠‡∏á‡∏®‡∏≤‡πÄ‡∏ã‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏™</div>
            <div id="temp-status" class="status"></div>
        </div>
        <div class="card">
            <div class="label">üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô</div>
            <div class="value" id="hum">--</div>
            <div class="unit">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå (%)</div>
            <div id="hum-status" class="status"></div>
        </div>
        <div class="card">
            <div class="label">‚òÄÔ∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏™‡∏á</div>
            <div class="value" id="light">--</div>
            <div class="unit">Lux</div>
            <div id="light-status" class="status"></div>
        </div>
    </div>

    <div class="chart-container">
        <div class="label" style="margin-bottom: 15px;">üìä ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</div>
        <canvas id="historyChart"></canvas>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AlzaSyB3tG4hRUH-9Xgqh0n1Hr55-OJ-pryQmQo",
            authDomain: "lora-soil-monitoring-system.firebaseapp.com",
            databaseURL: "https://lora-soil-monitoring-system-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lora-soil-monitoring-system",
            storageBucket: "lora-soil-monitoring-system.appspot.com",
            messagingSenderId: "1084791863154",
            appId: "1:1084791863154:web:2dee154a1c66a390628feb",
            measurementId: "G-53QCBS3TGR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // ‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const sensorRef = ref(db, 'sensor_data');
        const historyRef = ref(db, 'sensor_history');

        let myChart; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö Instance ‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü

        function updateClock() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('date-time').innerText = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠: " + now.toLocaleDateString('th-TH', options);
        }
        setInterval(updateClock, 1000);

        // --- Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Real-time (‡∏Å‡∏≤‡∏£‡πå‡∏î 3 ‡πÉ‡∏ö) ---
        onValue(sensorRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                document.getElementById("temp").innerHTML = data.temp;
                document.getElementById("hum").innerHTML = data.humidity;
                document.getElementById("light").innerHTML = data.light;
                checkStatus(parseFloat(data.temp), parseFloat(data.humidity), parseFloat(data.light));
            }
        });

        // --- 3. Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Log ‡∏°‡∏≤‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü ---
        onValue(historyRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Array (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏∏‡πà‡∏° Push ID)
                const logEntries = Object.values(data);
                
                // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤, ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô
                const labels = logEntries.map(entry => entry.time || "--:--");
                const tempValues = logEntries.map(entry => parseFloat(entry.temp));
                const humValues = logEntries.map(entry => parseFloat(entry.humidity));
		const lightValues = logEntries.map(entry => parseFloat(entry.light));
                renderChart(labels, tempValues, humValues, lightValues);
            }
        });

        function renderChart(labels, tempPoints, humPoints) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            if (myChart) { myChart.destroy(); } // ‡∏•‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)',
                            data: humPoints,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)',
                            data: tempPoints,
                            borderColor: '#e74c3c',
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.3
                        }
			{
                    	    label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏™‡∏á (Lux)',
                    	   data: lightPoints,
                    	   borderColor: '#f1c40f', // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ó‡∏≠‡∏á/‡∏™‡πâ‡∏°
                    	   backgroundColor: 'rgba(241, 196, 15, 0.1)',
                    	   fill: false,
                           borderDash: [5, 5] // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡πÑ‡∏Ç‡πà‡∏õ‡∏•‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏™‡∏±‡∏ö‡∏™‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏≠‡∏∑‡πà‡∏ô
                }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°
        function checkStatus(temp, humidity, realLux) {
            const tStat = document.getElementById("temp-status");
            if (temp <= -100) { tStat.innerHTML = "‚ùå ‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏•‡∏∏‡∏î"; tStat.style.color = "gray"; }
            else if (temp > 30) { tStat.innerHTML = "üî• ‡∏£‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ"; tStat.style.color = "red"; }
            else if (temp > 25 ) { tStat.innerHTML = "‚ö†Ô∏è ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á"; tStat.style.color = "#ff5722"; }
            else if (temp >= 15) { tStat.innerHTML = "‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥"; tStat.style.color = "green"; }
            else { tStat.innerHTML = "‚ùÑÔ∏è ‡πÄ‡∏¢‡πá‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ"; tStat.style.color = "blue"; }

            const hStat = document.getElementById("hum-status");
            if (humidity < 60) { hStat.innerHTML = "üèúÔ∏è ‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á‡πÑ‡∏õ"; hStat.style.color = "grey"; }
            else if (humidity > 85) { hStat.innerHTML = "üåä ‡∏î‡∏¥‡∏ô‡πÅ‡∏â‡∏∞‡πÑ‡∏õ"; hStat.style.color = "blue"; }
            else { hStat.innerHTML = "‚úÖ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°"; hStat.style.color = "green"; }

            const lStat = document.getElementById("light-status");
            if (realLux < 3000) { lStat.innerHTML = "üåë ‡πÅ‡∏™‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å"; lStat.style.color = "gray"; }
            else if (realLux < 10000) { lStat.innerHTML = "‚õÖ ‡πÅ‡∏™‡∏á‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢"; lStat.style.color = "orange"; }
            else if (realLux <= 50000) { lStat.innerHTML = "‚úÖ ‡πÅ‡∏™‡∏á‡∏û‡∏≠‡πÄ‡∏´‡∏°‡∏≤‡∏∞"; lStat.style.color = "green"; }
            else { lStat.innerHTML = "‚òÄÔ∏è ‡πÅ‡∏™‡∏á‡∏à‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ"; lStat.style.color = "red"; }
        }
    </script>
</body>
</html>