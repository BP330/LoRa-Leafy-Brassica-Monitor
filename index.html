<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>LoRa Leafy Brassica Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://www.gstatic.com https://cdn.jsdelivr.net 'unsafe-inline';">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            background: #f0f4f7; 
            text-align: center; 
            margin: 0; 
            padding: 20px; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .header { 
            background: #27ae60; 
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            width: 100%;
            max-width: 800px;
        }

        .grid { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            flex-wrap: wrap; 
            width: 100%;
            margin-bottom: 30px;
        }

        .card { 
            background: white; 
            padding: 25px; 
            border-radius: 15px; 
            width: 220px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        }

        /* ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 25px; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü */
        }

        .label { color: #7f8c8d; font-size: 1.1rem; }
        .value { font-size: 2.5rem; font-weight: bold; color: #2c3e50; margin: 10px 0; }
        .unit { font-size: 1rem; color: #95a5a6; }
        .status { margin-top: 10px; font-weight: bold; font-size: 1.1rem; }
        #date-time { margin-bottom: 15px; font-size: 1.2rem; font-weight: bold; color: #2c3e50; }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .grid { flex-direction: column; align-items: center; gap: 15px; }
            .card { width: 85%; max-width: 300px; }
            .chart-container { width: 95%; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>LoRa Leafy Brassica Monitor</h1>
        <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏ú‡∏±‡∏Å‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ </p>
    </div>

    <div id="date-time">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    
    <div style="margin:20px 0;">
        üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:
        <input type="date" id="datePicker">
    </div>

    <div class="grid">
        <div class="card">
            <div class="label">üå°Ô∏è ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥</div>
            <div id="temp" class="value">--</div>
            <div class="unit">‡∏≠‡∏á‡∏®‡∏≤‡πÄ‡∏ã‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏™</div>
            <div id="temp-status" class="status"></div>
        </div>
        <div class="card">
            <div class="label">üíß ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô</div>
            <div id="hum" class="value">--</div>
            <div class="unit">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå (%)</div>
            <div id="hum-status" class="status"></div>
        </div>
        <div class="card">
            <div class="label">‚òÄÔ∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏™‡∏á</div>
            <div id="light" class="value">--</div>
            <div class="unit">Lux</div>
            <div id="light-status" class="status"></div>
        </div>
    </div>

    <div class="chart-container">
        <div class="label" style="margin-bottom: 10px;">üå°Ô∏è ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)</div>
        <canvas id="tempChart"></canvas>
    </div>

    <div class="chart-container">
        <div class="label" style="margin-bottom: 10px;">üíß ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô (%)</div>
        <canvas id="humChart"></canvas>
    </div>

    <div class="chart-container">
        <div class="label" style="margin-bottom: 10px;">‚òÄÔ∏è ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏™‡∏á (Lux)</div>
        <canvas id="lightChart"></canvas>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Firebase Config (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        const firebaseConfig = {
            apiKey: "AlzaSyB3tG4hRUH-9Xgqh0n1Hr55-OJ-pryQmQo",
            authDomain: "lora-soil-monitoring-system.firebaseapp.com",
            databaseURL: "https://lora-soil-monitoring-system-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "lora-soil-monitoring-system",
            storageBucket: "lora-soil-monitoring-system.appspot.com",
            messagingSenderId: "1084791863154",
            appId: "1:1084791863154:web:2dee154a1c66a390628feb",
            measurementId: "G-53QCBS3TGR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // ‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÇ‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firebase
        const sensorRef = ref(db, 'sensor_data');
        const historyRef = ref(db, 'sensor_history');

        let chartT, chartH, chartL; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö Instance ‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß
        let selectedDate = null;
        document.getElementById("datePicker").addEventListener("change", (e) => {
            selectedDate = e.target.value; // format: YYYY-MM-DD
        });
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        function updateClock() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('date-time').innerText = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠: " + now.toLocaleDateString('th-TH', options);
        }
        setInterval(updateClock, 1000); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

        // --- Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Real-time (‡∏Å‡∏≤‡∏£‡πå‡∏î 3 ‡πÉ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô) ---
        onValue(sensorRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                document.getElementById("temp").innerText = data.temp || "--";
                document.getElementById("hum").innerText = data.humidity || "--";
                document.getElementById("light").innerText = data.light || "--";
                checkStatus(parseFloat(data.temp), parseFloat(data.humidity), parseFloat(data.light));
            }
        });

        // --- Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Log ‡∏°‡∏≤‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü 3 ‡∏≠‡∏±‡∏ô ---
        onValue(historyRef, (snapshot) => {
            const raw = snapshot.val();
            if (!raw) return;

            let logs = Object.values(raw);

            // üëâ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏á
            if (selectedDate) {
                logs = logs.filter(l => l.date === selectedDate);
            }

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠ Firebase ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á)
            logs.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

            // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏∏‡∏î (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ï‡∏Å)
            logs = logs.slice(-30);
                const labels = logs.map(l => l.time || "--:--"); // ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡∏ô X
                
                // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏£‡∏≤‡∏ü ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á (null/undefined)
                const tVals = logs.map(l => parseFloat(l.temp) || 0);
                const hVals = logs.map(l => parseFloat(l.humidity) || 0);
                const lVals = logs.map(l => parseFloat(l.light) || 0);

                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏ó‡∏±‡πâ‡∏á 3 ‡∏≠‡∏±‡∏ô
                renderTempChart(labels, tVals);
                renderHumChart(labels, hVals);
                renderLightChart(labels, lVals);
            }
        );

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
        function renderTempChart(labels, tempPoints) {
            const ctx = document.getElementById('tempChart').getContext('2d');
            if (chartT) chartT.destroy(); // ‡∏•‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
            chartT = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ 
                        label: '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)', 
                        data: tempPoints, 
                        borderColor: '#e74c3c', // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                        backgroundColor: 'rgba(231, 76, 60, 0.1)', // ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≤‡∏ü
                        fill: true, // ‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏µ‡πÉ‡∏ï‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
                        tension: 0.3 // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } }, // ‡∏ã‡πà‡∏≠‡∏ô Label ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
                    scales: { y: { beginAtZero: true, title: { display: true, text: '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)' } } }
                }
            });
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô (‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
        function renderHumChart(labels, humPoints) {
            const ctx = document.getElementById('humChart').getContext('2d');
            if (chartH) chartH.destroy();
            chartH = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ 
                        label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô (%)', 
                        data: humPoints, 
                        borderColor: '#3498db', // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
                        backgroundColor: 'rgba(52, 152, 219, 0.1)', 
                        fill: true, 
                        tension: 0.3 
                    }]
                },
                options: { 
                    responsive: true,
                    plugins: { legend: { display: false } }, // ‡∏ã‡πà‡∏≠‡∏ô Label
                    scales: { y: { min: 0, max: 100, title: { display: true, text: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô (%)' } } } // ‡∏•‡πá‡∏≠‡∏Å‡∏™‡πÄ‡∏Å‡∏• 0-100
                }
            });
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏™‡∏á (‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
        function renderLightChart(labels, lightPoints) {
            const ctx = document.getElementById('lightChart').getContext('2d');
            if (chartL) chartL.destroy();
            chartL = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ 
                        label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏™‡∏á (Lux)', 
                        data: lightPoints, 
                        borderColor: '#f1c40f', // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ó‡∏≠‡∏á
                        backgroundColor: 'rgba(241, 196, 15, 0.1)', 
                        fill: true, 
                        tension: 0.3 
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } }, // ‡∏ã‡πà‡∏≠‡∏ô Label
                    scales: { y: { beginAtZero: true, title: { display: true, text: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏™‡∏á (Lux)' } } }
                }
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡πÉ‡∏ä‡πâ Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        function checkStatus(temp, humidity, realLux) {
            const tStat = document.getElementById("temp-status");
            if (temp <= -100) { tStat.innerHTML = "‚ùå ‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏•‡∏∏‡∏î"; tStat.style.color = "gray"; }
            else if (temp > 30) { tStat.innerHTML = "üî• ‡∏£‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ"; tStat.style.color = "red"; }
            else if (temp > 25 ) { tStat.innerHTML = "‚ö†Ô∏è ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á"; tStat.style.color = "#ff5722"; }
            else if (temp >= 15) { tStat.innerHTML = "‚úÖ ‡∏õ‡∏Å‡∏ï‡∏¥"; tStat.style.color = "green"; }
            else { tStat.innerHTML = "‚ùÑÔ∏è ‡πÄ‡∏¢‡πá‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ"; tStat.style.color = "blue"; }

            const hStat = document.getElementById("hum-status");
            if (humidity < 60) { hStat.innerHTML = "üèúÔ∏è ‡∏î‡∏¥‡∏ô‡πÅ‡∏´‡πâ‡∏á‡πÑ‡∏õ"; hStat.style.color = "grey"; }
            else if (humidity > 85) { hStat.innerHTML = "üåä ‡∏î‡∏¥‡∏ô‡πÅ‡∏â‡∏∞‡πÑ‡∏õ"; hStat.style.color = "blue"; }
            else { hStat.innerHTML = "‚úÖ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°"; hStat.style.color = "green"; }

            const lStat = document.getElementById("light-status");
            if (realLux < 3000) { lStat.innerHTML = "üåë ‡πÅ‡∏™‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å"; lStat.style.color = "gray"; }
            else if (realLux < 10000) { lStat.innerHTML = "‚õÖ ‡πÅ‡∏™‡∏á‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢"; lStat.style.color = "orange"; }
            else if (realLux <= 50000) { lStat.innerHTML = "‚úÖ ‡πÅ‡∏™‡∏á‡∏û‡∏≠‡πÄ‡∏´‡∏°‡∏≤‡∏∞"; lStat.style.color = "green"; }
            else { lStat.innerHTML = "‚òÄÔ∏è ‡πÅ‡∏™‡∏á‡∏à‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ"; lStat.style.color = "red"; }
        }
    </script>
</body>
</html>